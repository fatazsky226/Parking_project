{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center mb-4">Administrateur {{ user.username }}</h2>
    
    <div class="row mb-4">
        <!-- Carte de Parking -->
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card shadow-lg border-light rounded">
                <div class="card-body text-center">
                    <h5 class="card-title" id="parking-lot-name">Parking Lot: </h5>
                    <p class="card-text">N° Parking: {{ uids.id }}</p>
                    <p class="font-weight-bold text-primary">Nombre de places : {{ uids.parking_lot.capacity }}</p>
                    <p class="card-text" id="parking-status-text">Status: </p>
                </div>
            </div>
        </div>
    </div>

    <h3 class="text-center mt-5">Parking Disponibilité</h3>
    <div class="text-center mt-3 mb-4">
        <canvas id="parkingChart" width="400" height="200"></canvas>
    </div>
</div>

<!-- Importer Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">

<!-- Importer Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Script pour la gestion des données -->
<script>
    const ctx = document.getElementById('parkingChart').getContext('2d');
    const parkingChart = new Chart(ctx, {
        type: 'doughnut', // Type de graphique (peut être modifié selon vos préférences)
        data: {
            labels: ['Occupé', 'Disponible'],
            datasets: [{
                label: 'Statut du Parking',
                data: [0, {{ uids.parking_lot.capacity }}], // Données initiales
                backgroundColor: [
                    'rgba(255, 99, 132, 0.7)', // Rouge pour occupé
                    'rgba(75, 192, 192, 0.7)'  // Vert pour disponible
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(75, 192, 192, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                }
            }
        }
    });

    // Fonction pour récupérer le dernier statut
    function fetchLatestStatus() {
        fetch("{% url 'get_last_sensor_data' %}")  // Assurez-vous que l'URL correspond à celle définie dans vos urls.py
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.log(data.error);
                } else {
                    // Mise à jour des éléments avec les données
                    document.getElementById('parking-lot-name').innerText = 'Parking Lot: ' + data.parking_lot;
                    document.getElementById('parking-status-text').innerText = 'Status: ' + data.status;

                    // Mise à jour du graphique
                    const totalCapacity = {{ uids.parking_lot.capacity }};
                    const occupied = data.occupied_spaces;
                    const available = totalCapacity - occupied;

                    parkingChart.data.datasets[0].data = [occupied, available];
                    parkingChart.update();
                }
            })
            .catch(error => console.log('Error fetching data:', error));
    }

    // Appeler la fonction toutes les 5 secondes pour mettre à jour le status
    setInterval(fetchLatestStatus, 5000);  // Intervalle en millisecondes (5000 ms = 5 secondes)
</script>

{% endblock %}
